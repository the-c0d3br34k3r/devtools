<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Tools Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Prism JS theme for syntax highlighting -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"> -->
    <link rel="stylesheet" href="script/css/prism-tomorrow.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .tool-panel {
            display: none;
        }
        .tool-panel.active {
            display: block;
        }
        .diff-line {
            padding-left: 1.5rem;
            position: relative;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .diff-line::before {
            content: attr(data-prefix);
            position: absolute;
            left: 0;
            width: 1.5rem;
            text-align: center;
            font-weight: bold;
        }
        .diff-add {
            background-color: rgba(16, 185, 129, 0.1);
        }
        .diff-add::before {
            content: '+';
            color: #10b981; /* green-500 */
        }
        .diff-remove {
            background-color: rgba(239, 68, 68, 0.1);
        }
        .diff-remove::before {
            content: '-';
            color: #ef4444; /* red-500 */
        }
        .diff-sbs .diff-line {
            min-height: 1.5rem; /* Ensure empty lines are visible */
        }
        .diff-sbs .diff-line::before {
            display: none; /* Hide prefix for side-by-side */
        }
        .diff-sbs-placeholder {
            background-color: rgba(55, 65, 81, 0.2);
        }
        .regex-match {
            background-color: rgba(234, 179, 8, 0.3);
            border-radius: 2px;
            box-shadow: 0 0 0 1px rgba(234, 179, 8, 0.7);
        }
        /* HAR Diagram Styles */
        #har-diagram-svg text {
            font-size: 12px;
            fill: #d1d5db; /* gray-300 */
        }
        #har-diagram-svg .lifeline {
            stroke: #4b5563; /* gray-600 */
            stroke-dasharray: 4 4;
        }
        #har-diagram-svg .req-arrow {
            stroke: #60a5fa; /* blue-400 */
            marker-end: url(#arrowhead-req);
        }
        #har-diagram-svg .res-arrow {
            stroke: #4ade80; /* green-400 */
            stroke-dasharray: 5 3;
            marker-end: url(#arrowhead-res);
        }
        #har-diagram-svg .interaction {
            cursor: pointer;
        }
        #har-diagram-svg .interaction:hover text {
            font-weight: bold;
            fill: #f9fafb; /* gray-50 */
        }
        /* IDE Syntax Highlighting Styles */
        .code-editor-wrapper {
            position: relative;
            height: 100%;
        }
        .code-editor-wrapper > textarea,
        .code-editor-wrapper > pre {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 1em;
            line-height: 1.5;
            overflow: auto;
        }
        .code-editor-wrapper > textarea {
            z-index: 1;
            background: transparent;
            color: transparent;
            caret-color: white;
            border: 2px solid transparent;
            resize: none;
        }
        .code-editor-wrapper > textarea:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-500 */
        }
        .code-editor-wrapper > pre {
            z-index: 0;
            background-color: #1f2937; /* gray-800 */
            border: 2px solid #374151; /* gray-700 */
            pointer-events: none;
        }
        .code-editor-wrapper > pre code {
             white-space: pre-wrap;
             word-break: break-all;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div class="flex flex-col h-screen">
        <!-- Header and Navigation -->
        <header class="bg-gray-800 shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span class="text-white text-xl ml-3 font-semibold">DevTools Suite</span>
                    </div>
                    <nav class="hidden md:flex space-x-4">
                        <a href="#formatter" class="nav-link bg-gray-900 text-white px-3 py-2 rounded-md text-sm font-medium">Formatter</a>
                        <a href="#diff" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Diff Checker</a>
                        <a href="#regex" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Regex Tester</a>
                        <a href="#har" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">HAR Analyzer</a>
                        <a href="#ide" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">IDE</a>
                        <a href="#crypto" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Encode/Encrypt</a>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8 overflow-auto">

            <!-- Universal Formatter Panel -->
            <div id="formatter" class="tool-panel active">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">Auto Formatter & Decoder</h2>
                    <div class="flex items-center space-x-4">
                         <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-400">Minify</span>
                            <label for="format-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="format-mode-toggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                            <span class="text-sm font-medium text-white">Indent</span>
                        </div>
                        <button id="clear-format-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Clear</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-[calc(100vh-17rem)]">
                    <div class="flex flex-col">
                        <label for="formatter-input" class="text-sm font-medium mb-2">Input</label>
                        <textarea id="formatter-input" class="flex-grow bg-gray-800 text-gray-300 border border-gray-700 rounded-md p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Paste your JSON, XML, Base64, or URL-encoded string..."></textarea>
                    </div>
                    <div class="flex flex-col">
                         <div class="flex justify-between items-center mb-2">
                            <label for="formatter-output" class="text-sm font-medium">Formatted Output</label>
                            <span id="detected-type" class="text-xs bg-gray-700 text-indigo-300 px-2 py-1 rounded-full"></span>
                        </div>
                        <div class="flex-grow relative bg-gray-800 border border-gray-700 rounded-md">
                            <pre id="formatter-output" class="h-full w-full p-3 overflow-auto whitespace-pre-wrap break-words"><code></code></pre>
                             <button id="copy-format" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded-md text-xs">Copy</button>
                        </div>
                    </div>
                </div>
                <div id="formatter-error" class="mt-4 text-red-400 h-6"></div>
            </div>

            <!-- Diff Checker Panel -->
            <div id="diff" class="tool-panel">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">Auto Diff Checker</h2>
                    <div class="flex items-center space-x-4">
                         <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-400">Inline</span>
                            <label for="diff-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="diff-mode-toggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-800 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                            <span class="text-sm font-medium text-white">Side-by-Side</span>
                        </div>
                        <button id="clear-diff-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Clear</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-[calc(100vh-22rem)]">
                    <div class="flex flex-col">
                        <label for="diff-original" class="text-sm font-medium mb-2">Original Text</label>
                        <textarea id="diff-original" class="flex-grow bg-gray-800 text-gray-300 border border-gray-700 rounded-md p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Paste original text here..."></textarea>
                    </div>
                    <div class="flex flex-col">
                        <label for="diff-changed" class="text-sm font-medium mb-2">Changed Text</label>
                        <textarea id="diff-changed" class="flex-grow bg-gray-800 text-gray-300 border border-gray-700 rounded-md p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Paste changed text here..."></textarea>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-medium text-white mb-2">Result</h3>
                    <div id="diff-output-container" class="bg-gray-800 border border-gray-700 rounded-md p-3 overflow-auto text-sm"></div>
                </div>
            </div>

            <!-- Regex Tester Panel -->
            <div id="regex" class="tool-panel">
                <h2 class="text-2xl font-bold text-white mb-4">Regex Tester</h2>
                <div class="space-y-4">
                    <div>
                        <label for="regex-pattern" class="text-sm font-medium">Regular Expression</label>
                        <div class="flex mt-1">
                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-700 bg-gray-800 text-gray-400 sm:text-sm">/</span>
                            <input type="text" id="regex-pattern" class="flex-1 block w-full rounded-none bg-gray-800 border-gray-700 focus:ring-indigo-500 focus:border-indigo-500" placeholder="your-pattern-here">
                            <span class="inline-flex items-center px-3 border border-l-0 border-gray-700 bg-gray-800 text-gray-400 sm:text-sm">/</span>
                            <input type="text" id="regex-flags" class="w-20 rounded-r-md bg-gray-800 border-gray-700 border-l-0 focus:ring-indigo-500 focus:border-indigo-500" placeholder="flags (gim)">
                        </div>
                    </div>
                    <div>
                        <label for="regex-string" class="text-sm font-medium">Test String</label>
                        <div id="regex-string-output" class="mt-1 bg-gray-800 text-gray-300 border border-gray-700 rounded-md p-3 min-h-[150px] whitespace-pre-wrap break-words" contenteditable="true">Enter your test string here. Try typing 'The quick brown fox jumps over the lazy dog.' and searching for 'fox'.</div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-white">Matches</h3>
                        <div id="regex-matches" class="mt-2 bg-gray-800 border border-gray-700 rounded-md p-3 min-h-[100px] text-sm">
                            <span class="text-gray-500">No matches found.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HAR Analyzer Panel -->
            <div id="har" class="tool-panel">
                 <h2 class="text-2xl font-bold text-white mb-4">HAR Sequence Diagram Analyzer</h2>
                <div class="grid grid-cols-12 gap-6 h-[calc(100vh-14rem)]">
                    <div class="col-span-12 md:col-span-3 flex flex-col space-y-4">
                        <div>
                            <label for="har-file-input" class="block text-sm font-medium mb-2">Upload .har file</label>
                            <input id="har-file-input" type="file" accept=".har" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer"/>
                        </div>
                        <div class="flex-grow flex flex-col min-h-0">
                            <h3 class="text-lg font-medium text-white mb-2">Filter by Host</h3>
                            <div id="har-hosts-container" class="flex-grow overflow-y-auto bg-gray-800 border border-gray-700 rounded-md p-3 space-y-2">
                                <p class="text-gray-500">Upload a HAR file to see hosts.</p>
                            </div>
                            <div class="mt-2">
                                <button id="har-select-all" class="text-xs text-indigo-400 hover:underline">Select All</button> / 
                                <button id="har-deselect-all" class="text-xs text-indigo-400 hover:underline">Deselect All</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-12 md:col-span-9 bg-gray-800 border border-gray-700 rounded-md overflow-auto">
                        <div id="har-diagram-container">
                            <svg id="har-diagram-svg" width="100%" height="100%">
                                <defs>
                                    <marker id="arrowhead-req" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#60a5fa" /></marker>
                                    <marker id="arrowhead-res" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#4ade80" /></marker>
                                </defs>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- IDE Panel -->
            <div id="ide" class="tool-panel">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-white">Python IDE (WASM)</h2>
                    <button id="ide-run-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        <span id="ide-run-btn-text">Loading Python...</span>
                    </button>
                </div>
                <div class="grid grid-cols-1 gap-4 h-[calc(100vh-18rem)]">
                    <div class="flex flex-col">
                        <label for="ide-code-input" class="text-sm font-medium mb-2">Code Editor</label>
                        <div class="code-editor-wrapper flex-grow">
                            <textarea id="ide-code-input" spellcheck="false"></textarea>
                            <pre id="ide-highlighting" aria-hidden="true"><code class="language-python"></code></pre>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label for="ide-output" class="text-sm font-medium mb-2">Output</label>
                        <pre id="ide-output" class="flex-grow bg-black text-white border border-gray-700 rounded-md p-3 overflow-auto text-sm font-mono"></pre>
                    </div>
                </div>
            </div>
            
            <!-- Encode/Encrypt Panel -->
            <div id="crypto" class="tool-panel">
                <h2 class="text-2xl font-bold text-white mb-4">Encode / Encrypt</h2>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <div class="flex items-center space-x-4">
                        <label for="crypto-algorithm" class="text-sm font-medium">Algorithm:</label>
                        <select id="crypto-algorithm" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2">
                            <option value="base64">Base64 Encode</option>
                            <option value="base32">Base32 Encode</option>
                            <option value="url">URL Encode</option>
                            <option value="aes">AES-GCM Encrypt</option>
                        </select>
                        <div id="aes-key-container" class="hidden">
                            <input type="password" id="aes-key-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2" placeholder="Enter password/key">
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="crypto-run-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Run</button>
                        <button id="crypto-clear-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Clear</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-[calc(100vh-22rem)]">
                    <div class="flex flex-col">
                        <label for="crypto-input" class="text-sm font-medium mb-2">Input</label>
                        <textarea id="crypto-input" class="flex-grow bg-gray-800 text-gray-300 border border-gray-700 rounded-md p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Enter text to process..."></textarea>
                    </div>
                    <div class="flex flex-col">
                        <label for="crypto-output" class="text-sm font-medium mb-2">Output</label>
                        <div class="flex-grow relative bg-gray-800 border border-gray-700 rounded-md">
                            <pre id="crypto-output" class="h-full w-full p-3 overflow-auto whitespace-pre-wrap break-words"><code></code></pre>
                            <button id="copy-crypto" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded-md text-xs">Copy</button>
                        </div>
                    </div>
                </div>
                <div id="crypto-error" class="mt-4 text-red-400 h-6"></div>
            </div>

        </main>
    </div>

    <!-- HAR Details Modal -->
    <div id="har-details-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 id="har-modal-title" class="text-xl font-bold text-white">Interaction Details</h3>
                <button id="har-modal-close" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="har-modal-content" class="p-4 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[150%] transition-transform duration-300 ease-in-out">
        Copied to clipboard!
    </div>
    
    <!-- Prism JS for syntax highlighting -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script> -->
    <script src="script/js/prism-core.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script> -->
     <script src="script/js/prism-autoloader.min.js"></script>
    <!-- Pyodide (Python in WASM) -->
    <!-- <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script> -->
    <script src="script/js/pyodide.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const navLinks = document.querySelectorAll('.nav-link');
            const toolPanels = document.querySelectorAll('.tool-panel');

            function showPanel(hash) {
                const targetId = hash ? hash.substring(1) : 'formatter';
                toolPanels.forEach(panel => panel.classList.toggle('active', panel.id === targetId));
                navLinks.forEach(link => {
                    const isActive = link.getAttribute('href') === `#${targetId}`;
                    link.classList.toggle('bg-gray-900', isActive);
                    link.classList.toggle('text-white', isActive);
                    link.classList.toggle('text-gray-300', !isActive);
                    link.classList.toggle('hover:bg-gray-700', !isActive);
                });
            }
            navLinks.forEach(link => link.addEventListener('click', e => {
                e.preventDefault();
                window.location.hash = link.getAttribute('href');
            }));
            window.addEventListener('hashchange', () => showPanel(window.location.hash));
            showPanel(window.location.hash);
            
            // --- Utility Functions ---
            const messageBox = document.getElementById('message-box');
            function showMessage(text) {
                messageBox.textContent = text;
                messageBox.classList.remove('translate-x-[150%]');
                setTimeout(() => {
                    messageBox.classList.add('translate-x-[150%]');
                }, 2000);
            }

            function copyToClipboard(text) {
                if (!text) return;
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessage('Copied to clipboard!');
                } catch (err) {
                    showMessage('Failed to copy!');
                }
                document.body.removeChild(textarea);
            }
            
            function escapeHtml(text) {
                return text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }

            // --- Auto Formatter Logic (Updated for Multi-level Decoding) ---
            const formatterInput = document.getElementById('formatter-input');
            const formatterOutputCode = document.querySelector('#formatter-output code');
            const clearFormatBtn = document.getElementById('clear-format-btn');
            const copyFormatBtn = document.getElementById('copy-format');
            const formatterError = document.getElementById('formatter-error');
            const formatModeToggle = document.getElementById('format-mode-toggle');
            const detectedTypeSpan = document.getElementById('detected-type');

            function prettyFormatXml(xml) {
                let formatted = '', indent = '';
                const tab = '    ';
                xml.split(/>\s*</).forEach(node => {
                    if (node.match(/^\/\w/)) indent = indent.substring(tab.length);
                    formatted += indent + '<' + node.replace(/^\s\s*/, '') + '>\n';
                    if (node.match(/^<?\w[^>]*[^\/]$/)) indent += tab;
                });
                return formatted.substring(1, formatted.length - 2);
            }
            
            function updateDetectedStatus(chain) {
                if (chain.length > 0) {
                    detectedTypeSpan.textContent = `Detected: ${chain.join(' âž” ')}`;
                    detectedTypeSpan.style.display = 'inline-block';
                } else {
                    detectedTypeSpan.style.display = 'none';
                }
            }

            function autoDetectAndFormat() {
                const isIndentMode = formatModeToggle.checked;
                const input = formatterInput.value.trim();
                
                formatterError.textContent = '';
                updateDetectedStatus([]);

                if (!input) {
                    formatterOutputCode.textContent = '';
                    return;
                }

                let detectedChain = [];
                let processedInput = input;
                let lastInput = '';

                while(processedInput !== lastInput) {
                    lastInput = processedInput;
                    let decodedThisIteration = false;

                    try {
                        const base64Regex = /^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/;
                        if (base64Regex.test(processedInput) && processedInput.length > 0 && processedInput.length % 4 === 0) {
                            const decoded = atob(processedInput);
                            if (!/[\x00-\x08\x0E-\x1F]/.test(decoded)) {
                                processedInput = decoded;
                                detectedChain.push('Base64');
                                decodedThisIteration = true;
                            }
                        }
                    } catch (e) {}

                    try {
                        if (!decodedThisIteration && processedInput.includes('%')) {
                            const decoded = decodeURIComponent(processedInput.replace(/\+/g, ' '));
                            if (decoded !== processedInput) {
                                processedInput = decoded;
                                detectedChain.push('URL Encoded');
                            }
                        }
                    } catch (e) {}
                }
                
                try {
                    const parsed = JSON.parse(processedInput);
                    formatterOutputCode.textContent = isIndentMode ? JSON.stringify(parsed, null, 4) : JSON.stringify(parsed);
                    detectedChain.push('JSON');
                    updateDetectedStatus(detectedChain);
                    return;
                } catch (e) {}

                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(processedInput, "application/xml");
                    if (doc.querySelector("parsererror")) throw new Error();
                    formatterOutputCode.textContent = isIndentMode ? prettyFormatXml(processedInput) : processedInput.replace(/>\s*</g, '><').trim();
                    detectedChain.push('XML');
                    updateDetectedStatus(detectedChain);
                    return;
                } catch (e) {}

                if (detectedChain.length > 0) {
                    formatterOutputCode.textContent = processedInput;
                    updateDetectedStatus(detectedChain);
                    return;
                }

                formatterOutputCode.textContent = '';
                formatterError.textContent = 'Error: Input is not valid JSON, XML, Base64, or URL Encoded text.';
            }

            formatterInput.addEventListener('input', autoDetectAndFormat);
            formatModeToggle.addEventListener('change', autoDetectAndFormat);
            clearFormatBtn.addEventListener('click', () => {
                formatterInput.value = '';
                autoDetectAndFormat();
            });
            copyFormatBtn.addEventListener('click', () => copyToClipboard(formatterOutputCode.textContent));

            // --- Diff Checker Logic ---
            const diffOriginal = document.getElementById('diff-original');
            const diffChanged = document.getElementById('diff-changed');
            const diffOutputContainer = document.getElementById('diff-output-container');
            const diffModeToggle = document.getElementById('diff-mode-toggle');
            const clearDiffBtn = document.getElementById('clear-diff-btn');

            function performDiff() {
                const isSideBySide = diffModeToggle.checked;
                const text1 = diffOriginal.value.split('\n');
                const text2 = diffChanged.value.split('\n');
                isSideBySide ? renderSideBySideDiff(text1, text2) : renderInlineDiff(text1, text2);
            }

            function renderInlineDiff(text1, text2) {
                const maxLen = Math.max(text1.length, text2.length);
                let resultHTML = '';
                for (let i = 0; i < maxLen; i++) {
                    if (text1[i] === undefined) {
                        resultHTML += `<div class="diff-line diff-add">${escapeHtml(text2[i])}</div>`;
                    } else if (text2[i] === undefined) {
                        resultHTML += `<div class="diff-line diff-remove">${escapeHtml(text1[i])}</div>`;
                    } else if (text1[i] !== text2[i]) {
                        resultHTML += `<div class="diff-line diff-remove">${escapeHtml(text1[i])}</div>`;
                        resultHTML += `<div class="diff-line diff-add">${escapeHtml(text2[i])}</div>`;
                    } else {
                        resultHTML += `<div class="diff-line">${escapeHtml(text1[i])}</div>`;
                    }
                }
                diffOutputContainer.innerHTML = `<pre>${resultHTML || '<span class="text-gray-500">No differences.</span>'}</pre>`;
            }

            function renderSideBySideDiff(a, b) {
                const N = a.length, M = b.length;
                const dp = Array(N + 1).fill(0).map(() => Array(M + 1).fill(0));
                for (let i = 1; i <= N; i++) for (let j = 1; j <= M; j++) dp[i][j] = a[i - 1] === b[j - 1] ? 1 + dp[i - 1][j - 1] : Math.max(dp[i - 1][j], dp[i][j - 1]);
                let leftHTML = '', rightHTML = '';
                let i = N, j = M;
                while (i > 0 || j > 0) {
                    if (i > 0 && j > 0 && a[i - 1] === b[j - 1]) {
                        leftHTML = `<div class="diff-line">${escapeHtml(a[i-1])}</div>` + leftHTML;
                        rightHTML = `<div class="diff-line">${escapeHtml(b[j-1])}</div>` + rightHTML;
                        i--; j--;
                    } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
                        leftHTML = `<div class="diff-line diff-sbs-placeholder">&nbsp;</div>` + leftHTML;
                        rightHTML = `<div class="diff-line diff-add">${escapeHtml(b[j-1])}</div>` + rightHTML;
                        j--;
                    } else if (i > 0 && (j === 0 || dp[i][j - 1] < dp[i - 1][j])) {
                        leftHTML = `<div class="diff-line diff-remove">${escapeHtml(a[i-1])}</div>` + leftHTML;
                        rightHTML = `<div class="diff-line diff-sbs-placeholder">&nbsp;</div>` + rightHTML;
                        i--;
                    } else { break; }
                }
                diffOutputContainer.innerHTML = `<div class="grid grid-cols-2 gap-4 diff-sbs"><pre>${leftHTML}</pre><pre>${rightHTML}</pre></div>`;
                if (!leftHTML && !rightHTML) diffOutputContainer.innerHTML = '<span class="text-gray-500">No differences.</span>';
            }

            diffOriginal.addEventListener('input', performDiff);
            diffChanged.addEventListener('input', performDiff);
            diffModeToggle.addEventListener('change', performDiff);
            clearDiffBtn.addEventListener('click', () => {
                diffOriginal.value = '';
                diffChanged.value = '';
                performDiff();
            });
            performDiff();

            // --- Regex Tester Logic ---
            const regexPattern = document.getElementById('regex-pattern');
            const regexFlags = document.getElementById('regex-flags');
            const regexStringOutput = document.getElementById('regex-string-output');
            const regexMatches = document.getElementById('regex-matches');

            function testRegex() {
                const pattern = regexPattern.value, flags = regexFlags.value, testString = regexStringOutput.textContent;
                if (!pattern) {
                    regexStringOutput.innerHTML = testString.replace(/<\/?span[^>]*>/g, '');
                    regexMatches.innerHTML = '<span class="text-gray-500">Enter a pattern to test.</span>';
                    return;
                }
                try {
                    const regex = new RegExp(pattern, flags);
                    let highlightedString = testString, matchesResult = '';
                    if (flags.includes('g')) {
                        const matches = [...testString.matchAll(regex)];
                        if (matches.length > 0) {
                            highlightedString = testString.replace(regex, (match) => `<span class="regex-match">${escapeHtml(match)}</span>`);
                            matches.forEach((m, i) => matchesResult += `<div class="p-1 border-b border-gray-700"><strong>Match ${i + 1}:</strong> ${escapeHtml(m[0])} (index: ${m.index})</div>`);
                        }
                    } else {
                        const match = testString.match(regex);
                        if (match) {
                            highlightedString = testString.replace(regex, `<span class="regex-match">${escapeHtml(match[0])}</span>`);
                            matchesResult = `<div class="p-1"><strong>Match 1:</strong> ${escapeHtml(match[0])} (index: ${match.index})</div>`;
                        }
                    }
                    regexStringOutput.innerHTML = highlightedString;
                    regexMatches.innerHTML = matchesResult || '<span class="text-gray-500">No matches found.</span>';
                } catch (e) {
                    regexMatches.innerHTML = `<span class="text-red-400">Invalid Regex: ${e.message}</span>`;
                }
            }
            regexPattern.addEventListener('input', testRegex);
            regexFlags.addEventListener('input', testRegex);
            regexStringOutput.addEventListener('input', testRegex);
            testRegex();

            // --- HAR Analyzer Logic ---
            const harFileInput = document.getElementById('har-file-input');
            const harHostsContainer = document.getElementById('har-hosts-container');
            const harDiagramSvg = document.getElementById('har-diagram-svg');
            const harSelectAll = document.getElementById('har-select-all');
            const harDeselectAll = document.getElementById('har-deselect-all');
            const harModal = document.getElementById('har-details-modal');
            const harModalTitle = document.getElementById('har-modal-title');
            const harModalContent = document.getElementById('har-modal-content');
            const harModalClose = document.getElementById('har-modal-close');
            let harData = null;

            harFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = JSON.parse(e.target.result);
                        if (content.log && content.log.entries) {
                            harData = content;
                            populateHostFilters();
                            renderHarDiagram();
                        } else { showMessage('Invalid HAR file format.'); }
                    } catch (err) { showMessage('Error parsing HAR file: ' + err.message); }
                };
                reader.readAsText(file);
            });

            function populateHostFilters() {
                if (!harData) return;
                const hosts = new Set(harData.log.entries.map(e => new URL(e.request.url).hostname));
                harHostsContainer.innerHTML = '';
                Array.from(hosts).sort().forEach(host => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `host-${host}`;
                    checkbox.value = host;
                    checkbox.checked = true;
                    checkbox.className = 'h-4 w-4 rounded border-gray-600 bg-gray-900 text-indigo-600 focus:ring-indigo-600';
                    checkbox.addEventListener('change', renderHarDiagram);
                    const label = document.createElement('label');
                    label.htmlFor = `host-${host}`;
                    label.textContent = host;
                    label.className = 'ml-2 block text-sm text-gray-300';
                    div.append(checkbox, label);
                    harHostsContainer.appendChild(div);
                });
            }
            
            harSelectAll.addEventListener('click', () => { harHostsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true); renderHarDiagram(); });
            harDeselectAll.addEventListener('click', () => { harHostsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); renderHarDiagram(); });

            function renderHarDiagram() {
                if (!harData) return;
                const selectedHosts = Array.from(harHostsContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                const filteredEntries = harData.log.entries.filter(e => selectedHosts.includes(new URL(e.request.url).hostname));
                harDiagramSvg.innerHTML = harDiagramSvg.querySelector('defs').outerHTML;
                if (filteredEntries.length === 0) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', '50%'); text.setAttribute('y', '50'); text.setAttribute('text-anchor', 'middle'); text.textContent = 'No entries for selected hosts.';
                    harDiagramSvg.appendChild(text);
                    return;
                }
                const participants = ['Browser', ...selectedHosts];
                const participantX = {};
                const padding = 100;
                const width = Math.max(participants.length * 150 + padding * 2, harDiagramSvg.parentElement.clientWidth);
                const height = filteredEntries.length * 80 + 100;
                harDiagramSvg.setAttribute('width', width); harDiagramSvg.setAttribute('height', height);
                participants.forEach((p, i) => {
                    const x = i * ((width - padding * 2) / (participants.length - 1)) + padding;
                    participantX[p] = x;
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x); text.setAttribute('y', 30); text.setAttribute('text-anchor', 'middle'); text.textContent = p;
                    harDiagramSvg.appendChild(text);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x); line.setAttribute('y1', 50); line.setAttribute('x2', x); line.setAttribute('y2', height - 20); line.setAttribute('class', 'lifeline');
                    harDiagramSvg.appendChild(line);
                });
                filteredEntries.forEach((entry, i) => {
                    const y = i * 80 + 80;
                    const browserX = participantX['Browser'];
                    const hostX = participantX[new URL(entry.request.url).hostname];
                    if (hostX === undefined) return;
                    const reqGroup = createInteractionGroup(entry, 'request');
                    reqGroup.appendChild(createArrow(browserX, hostX, y, 'req-arrow'));
                    reqGroup.appendChild(createText(`${entry.request.method} ${new URL(entry.request.url).pathname}`, browserX, hostX, y - 5));
                    harDiagramSvg.appendChild(reqGroup);
                    const resGroup = createInteractionGroup(entry, 'response');
                    resGroup.appendChild(createArrow(hostX, browserX, y + 30, 'res-arrow'));
                    resGroup.appendChild(createText(`${entry.response.status} ${entry.response.statusText}`, hostX, browserX, y + 25));
                    harDiagramSvg.appendChild(resGroup);
                });
            }

            function createInteractionGroup(entry, type) {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'interaction');
                g.dataset.entryIndex = harData.log.entries.indexOf(entry);
                g.dataset.type = type;
                g.addEventListener('click', showHarDetails);
                return g;
            }

            function createArrow(x1, x2, y, className) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1); line.setAttribute('y1', y); line.setAttribute('x2', x2 - (x1 < x2 ? 10 : -10)); line.setAttribute('y2', y); line.setAttribute('class', className);
                return line;
            }

            function createText(content, x1, x2, y) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', (x1 + x2) / 2); text.setAttribute('y', y); text.setAttribute('text-anchor', 'middle');
                text.textContent = content.length > 50 ? content.substring(0, 47) + '...' : content;
                return text;
            }

            function showHarDetails(event) {
                const g = event.currentTarget;
                const entry = harData.log.entries[g.dataset.entryIndex];
                const type = g.dataset.type;
                const data = (type === 'request') ? entry.request : entry.response;
                harModalTitle.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)}: ${data.url || entry.request.url}`;
                let contentHTML = '<h4>Headers</h4><pre class="bg-gray-900 p-2 rounded-md text-sm whitespace-pre-wrap break-all"><code>';
                data.headers.forEach(h => contentHTML += `${h.name}: ${h.value}\n`);
                contentHTML += '</code></pre>';
                const body = (type === 'request') ? data.postData : data.content;
                if (body && body.text) {
                    contentHTML += '<h4 class="mt-4">Body</h4><pre class="bg-gray-900 p-2 rounded-md text-sm whitespace-pre-wrap break-all"><code>';
                    try { contentHTML += JSON.stringify(JSON.parse(body.text), null, 2); } catch (e) { contentHTML += escapeHtml(body.text); }
                    contentHTML += '</code></pre>';
                }
                harModalContent.innerHTML = contentHTML;
                harModal.classList.remove('hidden');
            }
            harModalClose.addEventListener('click', () => harModal.classList.add('hidden'));

            // --- IDE Logic ---
            const ideRunBtn = document.getElementById('ide-run-btn');
            const ideRunBtnText = document.getElementById('ide-run-btn-text');
            const ideCodeInput = document.getElementById('ide-code-input');
            const ideHighlightingPre = document.getElementById('ide-highlighting');
            const ideHighlightingCode = ideHighlightingPre.querySelector('code');
            const ideOutput = document.getElementById('ide-output');
            let pyodide = null;
            ideCodeInput.value = 'import sys\n\nprint(f"Hello from Python {sys.version}")';
            function syncHighlighting() {
                const code = ideCodeInput.value;
                ideHighlightingCode.textContent = code;
                Prism.highlightElement(ideHighlightingCode);
                ideHighlightingPre.scrollTop = ideCodeInput.scrollTop;
                ideHighlightingPre.scrollLeft = ideCodeInput.scrollLeft;
            }
            ideCodeInput.addEventListener('input', syncHighlighting);
            ideCodeInput.addEventListener('scroll', syncHighlighting);
            async function initializePyodide() {
                try {
                    pyodide = await loadPyodide();
                    ideRunBtnText.textContent = 'Run';
                    ideRunBtn.disabled = false;
                    ideOutput.textContent += 'Python environment ready.\n';
                } catch (error) {
                    ideRunBtnText.textContent = 'Error';
                    ideOutput.textContent += `Error loading Python environment: ${error}\n`;
                }
            }
            initializePyodide();
            ideRunBtn.addEventListener('click', async () => {
                if (!pyodide) {
                    ideOutput.textContent = 'Python environment is not ready yet.';
                    return;
                }
                const code = ideCodeInput.value;
                ideOutput.textContent = `> Running Python code...\n\n`;
                ideRunBtn.disabled = true;
                ideRunBtnText.textContent = 'Running...';
                try {
                    let stdout_data = "", stderr_data = "";
                    pyodide.setStdout({ batched: (str) => stdout_data += str + "\n" });
                    pyodide.setStderr({ batched: (str) => stderr_data += str + "\n" });
                    await pyodide.runPythonAsync(code);
                    if (stdout_data) ideOutput.textContent += stdout_data;
                    if (stderr_data) ideOutput.textContent += `[ERROR] ${stderr_data}`;
                    if (!stdout_data && !stderr_data) ideOutput.textContent += 'Execution finished with no output.\n';
                } catch (error) {
                    ideOutput.textContent += `[ERROR] ${error.message}\n`;
                } finally {
                    ideRunBtn.disabled = false;
                    ideRunBtnText.textContent = 'Run';
                }
            });
            syncHighlighting();

            // --- Encode/Encrypt Logic ---
            const cryptoAlgorithm = document.getElementById('crypto-algorithm');
            const aesKeyContainer = document.getElementById('aes-key-container');
            const aesKeyInput = document.getElementById('aes-key-input');
            const cryptoRunBtn = document.getElementById('crypto-run-btn');
            const cryptoClearBtn = document.getElementById('crypto-clear-btn');
            const cryptoInput = document.getElementById('crypto-input');
            const cryptoOutputCode = document.querySelector('#crypto-output code');
            const cryptoError = document.getElementById('crypto-error');
            const copyCryptoBtn = document.getElementById('copy-crypto');

            cryptoAlgorithm.addEventListener('change', () => {
                aesKeyContainer.classList.toggle('hidden', cryptoAlgorithm.value !== 'aes');
            });

            cryptoClearBtn.addEventListener('click', () => {
                cryptoInput.value = '';
                cryptoOutputCode.textContent = '';
                cryptoError.textContent = '';
                aesKeyInput.value = '';
            });

            copyCryptoBtn.addEventListener('click', () => copyToClipboard(cryptoOutputCode.textContent));

            cryptoRunBtn.addEventListener('click', async () => {
                const algorithm = cryptoAlgorithm.value;
                const input = cryptoInput.value;
                cryptoOutputCode.textContent = '';
                cryptoError.textContent = '';

                if (!input) {
                    cryptoError.textContent = 'Input cannot be empty.';
                    return;
                }

                try {
                    let result = '';
                    switch (algorithm) {
                        case 'base64':
                            result = btoa(input);
                            break;
                        case 'base32':
                            result = base32Encode(new TextEncoder().encode(input));
                            break;
                        case 'url':
                            result = encodeURIComponent(input);
                            break;
                        case 'aes':
                            const password = aesKeyInput.value;
                            if (!password) {
                                cryptoError.textContent = 'Password/key is required for AES encryption.';
                                return;
                            }
                            result = await aesEncrypt(input, password);
                            break;
                    }
                    cryptoOutputCode.textContent = result;
                } catch (err) {
                    cryptoError.textContent = `Error: ${err.message}`;
                }
            });

            // --- Crypto Helper Functions ---
            function base32Encode(buffer) {
                const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
                let bits = 0;
                let bitLength = 0;
                let result = '';
                const view = new Uint8Array(buffer);

                for (let i = 0; i < view.length; i++) {
                    bits = (bits << 8) | view[i];
                    bitLength += 8;
                    while (bitLength >= 5) {
                        result += alphabet[(bits >>> (bitLength - 5)) & 31];
                        bitLength -= 5;
                    }
                }

                if (bitLength > 0) {
                    result += alphabet[(bits << (5 - bitLength)) & 31];
                }

                while (result.length % 8 !== 0) {
                    result += '=';
                }
                return result;
            }

            async function aesEncrypt(text, password) {
                const salt = new TextEncoder().encode('a-static-salt-for-this-tool'); // Use a static salt for simplicity
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const textEncoder = new TextEncoder();
                const data = textEncoder.encode(text);

                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    textEncoder.encode(password),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );

                const key = await crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: salt, iterations: 100000, hash: 'SHA-256' },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );

                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );

                const combined = new Uint8Array(iv.length + encrypted.byteLength);
                combined.set(iv);
                combined.set(new Uint8Array(encrypted), iv.length);

                // Return as Base64 string for easy storage/transport
                return btoa(String.fromCharCode.apply(null, combined));
            }

        });
    </script>
</body>
</html>
